# Homeassistant

## VL53L1X Time-of-Flight (ToF) laser-ranging sensor.

The VL53L1X is a state-of-the-art, Time-of-Flight (ToF) laser-ranging sensor, enhancing the ST FlightSense product family. It is the fastest miniature ToF sensor on the market with accurate ranging up to 4 m and fast ranging frequency up to 50 Hz.

The Homeassistant 'distance' sensor includes a rest definition that can be appended to the current Homeassistant configuration using the commands shown below:

```
git clone https://github.com/josemotta/iot-tofu
cd iot-tofu/rpi/vl53l1x/ha
sudo install-ha.sh

```

This is an example of a typical [configuration](configuration.yaml) file, expected to be **installed at RPIs** with proper sensor, not at Tofu boot server. It also extracts raw sensors data (temperature & current) from files as part of the sysfs interface. The HomeAssistant Overview page for VL53L1X Time-of-Flight (ToF) laser-ranging sensor is shown below.

![HomeAssistant VL53L1X Time-of-Flight (ToF) laser-ranging sensor](vl53l1x-screenshot3.png)

### Light interference

A test near a window, even without direct sun exposure, shows that VL53L1X sensor is affected by daylight, ranging from small variations of 1 cm during the night until up to 5 cm during the day time. The sensor shown below was aimed at the ceiling to measure a 2.2 m distance.

![Day-night test](vl53l1x-ha-day-night-test.jpeg)

![Light interference during the day](vl53l1x-ha-day-night-interference.png)

### Prototype for burn-in tests

A custom 3D printed case was built for five prototypes, two of them are shown below:

- Rpi#5 is loose & disconnected on the right side, showing the RJ-45 connector that powers & connects it to the local LAN. It shows also the external USB pen drive, needed to store the Docker containers that do not support remote boot disk.

![Prototype for burn-in tests](vl53l1x-burnin-prototype.JPG)

- To the left, Rpi#1 prototype is being used for burn in tests and is expected to participate in the first official mission. It is fixed by DIN rail inside the waterproof pink plastic box. It is wired to PoE+ switch together with Tofu and both are powered by local LAN, up to 100 meters away from PoE+ LAN switch. There are also four RJ-45 connectors in the 3D printed case specially designed for I2C pins to connect the VL53L1X sensor and/or other I2C devices.

- Looking up, on the top of a wood stick, we see the VL53L1X sensor protected by a plastic cover. It is supposed to be installed on the top of a big tank, pointing down to measure the water level continuously 24 hours a day. Up to 5 meters away from Rpi#1 Raspberry Pi, current tests are running fine to propagate the I2C bus to the process.

- Finally at bottom, the Tofu server supports the remote boot for Rpi#1 and any other Raspberrry Pi. It is also used to browse the Homeassistant frontend, since it has access to all Rpis in the local LAN.

### Screenshots

The first image show the results generated by the RPI4 running the following tasks for Homeassistant:

- keep measuring ´distance´ each couple seconds using the web API created for VL53L1X;
- keep updating 8 other homeassistant ´sensors´ with performance measures each 5 seconds;
- Homeassistant processes data input and stores it to be retrived later by frontend graphs.
- show homeassistant frontend webpages, browsed directly at local LAN using RPi IP;

The web browser is running at Tofu, since it has access to all RPis in the local LAN under his 'boot' region reign. A remote command window is also opened using 'ssh rpi1' and after running the ´htop' process viewer, with its known black screen, we can check the load average composed by three numbers. It indicates how much the CPU is being utilized, for example, at RPi4 quad-core processor, a load average of 4.0 means 100% CPU utilization. The numbers we see are 0.37 for the last minute, 0.29 for the last 5-minutes, and 0.26 for the last 15-minutes. This is an indication that big load improvements are still allowed for the Raspberry Pi, handling images from a camera for example.

![Screenshot from Boot server terminal](vl53l1x-screenshot.jpg)

After all tests, the most important characteristic for the IoT applications we are aiming is how long it provides safe and reliable information, uninterruptedly. For example, ´distance´ allows us to calculate how much water we have in a tank, based on the distance from water surface up to the VL53L1X sensor that is installed at the top. The arrangement should work all day, forever. Burn-in tests were done during 18 days with full stable operation.

![Homeassistant Graph from distance sensor](vl53l1x-ha-test-9.png)

After a test that increased RPi CPU load, the images below document the CPU temperature increase that was automatically controlled by raising the fan speed to 255 rpm. As well, later at night the temperature lowered and the fan speed was reduced to 64 rpm. The Homeassistant ![default setup](https://github.com/josemotta/iot-tofu/blob/sensor/rpi/vl53l1x/ha/configuration.yaml) handles this situation using the Sysfs interface.

![Homeassistant Rpi Cpu Temperature](vl53l1x-ha-cputemp.png)

![Homeassistant PoE+ Fan Speed](vl53l1x-ha-fanspeed.png)

Sysfs is a virtual filesystem that provides a user-friendly interface to the kernel's device model, exporting information about hardware devices, drivers, and their relationships. It is mounted at /sys and allows user-space programs to view and configure devices by reading and writing to virtual files that represent kernel data structures.
